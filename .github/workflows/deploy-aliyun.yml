name: Deploy To Aliyun

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: fbif_form
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d fbif_form"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            apps/web/package-lock.json
            apps/mock-api/package-lock.json
            apps/api/package-lock.json

      - name: Build And Test
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: |
          set -euo pipefail
          API_URL="${VITE_API_URL:-http://112.124.103.65:8080}"

          npm ci --prefix apps/api
          DATABASE_URL="postgresql://postgres:postgres@127.0.0.1:5432/fbif_form" npm run prisma:migrate --prefix apps/api
          npm test --prefix apps/api
          npm run build --prefix apps/api

          npm ci --prefix apps/mock-api
          npm test --prefix apps/mock-api
          npm ci --prefix apps/web
          VITE_API_URL="${API_URL}" npm run build --prefix apps/web

      - name: Package Release
        run: |
          set -euo pipefail
          rm -f /tmp/release.tgz release.tgz
          tar -czf /tmp/release.tgz \
            --exclude=".git" \
            --exclude=".github" \
            --exclude="release.tgz" \
            --exclude="./release.tgz" \
            --exclude="apps/web/node_modules" \
            --exclude="apps/mock-api/node_modules" \
            --exclude="apps/api/node_modules" \
            --exclude="apps/web/.env" \
            --exclude="apps/web/.env.*" \
            --exclude="apps/mock-api/.env" \
            --exclude="apps/mock-api/.env.*" \
            --exclude="apps/api/.env" \
            --exclude="apps/api/.env.*" \
            --exclude=".local-stack" \
            .
          cp /tmp/release.tgz release.tgz

      - name: Validate SSH Key
        env:
          ALIYUN_HOST: ${{ secrets.ALIYUN_HOST }}
          ALIYUN_USER: ${{ secrets.ALIYUN_USER }}
          ALIYUN_SSH_KEY: ${{ secrets.ALIYUN_SSH_KEY }}
          ALIYUN_SSH_KEY_B64: ${{ secrets.ALIYUN_SSH_KEY_B64 }}
        run: |
          set -euo pipefail
          HOST="${ALIYUN_HOST:-112.124.103.65}"
          USER="${ALIYUN_USER:-root}"

          mkdir -p ~/.ssh

          if [ -n "${ALIYUN_SSH_KEY:-}" ]; then
            KEY_HEAD="$(printf '%s' "${ALIYUN_SSH_KEY}" | head -n 1)"
            if printf '%s' "${KEY_HEAD}" | grep -qE '^ssh-(ed25519|rsa|dss) '; then
              echo "::error::ALIYUN_SSH_KEY looks like a public key. Please set the private key content."
              exit 1
            fi

            # Support pasted values with extra text around the key block.
            RAW_KEY="$(printf '%b' "${ALIYUN_SSH_KEY}" | tr -d '\r')"
            if printf '%s' "${RAW_KEY}" | grep -q -- '-----BEGIN OPENSSH PRIVATE KEY-----'; then
              printf '%s\n' "${RAW_KEY}" | awk '
                /-----BEGIN OPENSSH PRIVATE KEY-----/ {in_key=1}
                in_key {print}
                /-----END OPENSSH PRIVATE KEY-----/ {if (in_key) {exit}}
              ' > ~/.ssh/id_aliyun
            else
              printf '%s' "${RAW_KEY}" > ~/.ssh/id_aliyun
            fi
          elif [ -n "${ALIYUN_SSH_KEY_B64:-}" ]; then
            printf '%s' "${ALIYUN_SSH_KEY_B64}" | tr -d '\r\n ' | base64 -d > ~/.ssh/id_aliyun
          else
            echo "::error::Missing Actions secret: ALIYUN_SSH_KEY or ALIYUN_SSH_KEY_B64"
            exit 1
          fi

          chmod 600 ~/.ssh/id_aliyun

          if ! ssh-keygen -y -f ~/.ssh/id_aliyun >/dev/null 2>/tmp/ssh_key_err.log; then
            echo "::error::Invalid private key content in Actions secret."
            cat /tmp/ssh_key_err.log || true
            exit 1
          fi

          if ! ssh \
            -i ~/.ssh/id_aliyun \
            -o BatchMode=yes \
            -o ConnectTimeout=10 \
            -o StrictHostKeyChecking=accept-new \
            "${USER}@${HOST}" \
            "echo SSH_OK" >/tmp/ssh_probe_out.log 2>/tmp/ssh_probe_err.log; then
            if grep -qi "Permission denied" /tmp/ssh_probe_err.log; then
              echo "::error::SSH authentication failed. Ensure the public key is in server ~/.ssh/authorized_keys."
            elif grep -Eqi "Connection timed out|No route to host|Connection refused" /tmp/ssh_probe_err.log; then
              echo "::error::Cannot reach server SSH port 22 from GitHub Actions. Check Aliyun security group/firewall."
            else
              echo "::error::SSH probe failed. See logs below."
            fi
            cat /tmp/ssh_probe_err.log || true
            exit 1
          fi

          grep -q "SSH_OK" /tmp/ssh_probe_out.log

      - name: Upload Release To Server
        env:
          ALIYUN_HOST: ${{ secrets.ALIYUN_HOST }}
          ALIYUN_USER: ${{ secrets.ALIYUN_USER }}
        run: |
          set -euo pipefail
          HOST="${ALIYUN_HOST:-112.124.103.65}"
          USER="${ALIYUN_USER:-root}"

          scp \
            -i ~/.ssh/id_aliyun \
            -o BatchMode=yes \
            -o ConnectTimeout=20 \
            -o StrictHostKeyChecking=accept-new \
            release.tgz \
            "${USER}@${HOST}:/tmp/release.tgz"

      - name: Deploy On Server
        env:
          ALIYUN_HOST: ${{ secrets.ALIYUN_HOST }}
          ALIYUN_USER: ${{ secrets.ALIYUN_USER }}
          APP_DIR: ${{ secrets.APP_DIR }}
          WEB_ORIGIN: ${{ secrets.WEB_ORIGIN }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          DATA_KEY: ${{ secrets.DATA_KEY }}
          DATA_HASH_SALT: ${{ secrets.DATA_HASH_SALT }}
          FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
          FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
          FEISHU_APP_TOKEN: ${{ secrets.FEISHU_APP_TOKEN }}
          FEISHU_TABLE_ID: ${{ secrets.FEISHU_TABLE_ID }}
          OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
          OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
          OSS_REGION: ${{ secrets.OSS_REGION }}
          OSS_HOST: ${{ secrets.OSS_HOST }}
          OSS_PUBLIC_BASE_URL: ${{ secrets.OSS_PUBLIC_BASE_URL }}
          OSS_UPLOAD_PREFIX: ${{ secrets.OSS_UPLOAD_PREFIX }}
          OSS_MAX_UPLOAD_MB: ${{ secrets.OSS_MAX_UPLOAD_MB }}
          OSS_POLICY_EXPIRE_SECONDS: ${{ secrets.OSS_POLICY_EXPIRE_SECONDS }}
          OSS_OBJECT_ACL: ${{ secrets.OSS_OBJECT_ACL }}
          GH_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          HOST="${ALIYUN_HOST:-112.124.103.65}"
          USER="${ALIYUN_USER:-root}"

          cat > /tmp/remote_deploy.sh <<'REMOTE_SCRIPT'
            set -euo pipefail

            APP_ROOT="${APP_DIR:-/opt/web-fbif-form}"
            RELEASES_DIR="${APP_ROOT}/releases"
            CURRENT_LINK="${APP_ROOT}/current"
            RELEASE_DIR="${RELEASES_DIR}/${GH_SHA}"

            mkdir -p "${RELEASES_DIR}"
            rm -rf "${RELEASE_DIR}"
            mkdir -p "${RELEASE_DIR}"

            tar -xzf /tmp/release.tgz -C "${RELEASE_DIR}"

            npm ci --prefix "${RELEASE_DIR}/apps/api"

            SOURCE_ENV=""
            if [ -f "${CURRENT_LINK}/apps/api/.env" ]; then
              SOURCE_ENV="${CURRENT_LINK}/apps/api/.env"
            elif [ -f "${APP_ROOT}/apps/api/.env" ]; then
              SOURCE_ENV="${APP_ROOT}/apps/api/.env"
            fi

            if [ -n "${SOURCE_ENV}" ]; then
              cp "${SOURCE_ENV}" "${RELEASE_DIR}/apps/api/.env"
            else
              : "${DATABASE_URL:?Missing DATABASE_URL secret (or existing server apps/api/.env)}"
              : "${REDIS_URL:?Missing REDIS_URL secret (or existing server apps/api/.env)}"
              : "${DATA_KEY:?Missing DATA_KEY secret (or existing server apps/api/.env)}"
              : "${DATA_HASH_SALT:?Missing DATA_HASH_SALT secret (or existing server apps/api/.env)}"
              : "${FEISHU_APP_SECRET:?Missing FEISHU_APP_SECRET secret (or existing server .env)}"
              : "${FEISHU_APP_TOKEN:?Missing FEISHU_APP_TOKEN secret (or existing server .env)}"

              {
                echo "NODE_ENV=production"
                echo "PORT=8080"
                echo "WEB_ORIGIN=${WEB_ORIGIN:-http://112.124.103.65:3001}"
                echo "DATABASE_URL=${DATABASE_URL}"
                echo "REDIS_URL=${REDIS_URL}"
                echo "DATA_KEY=${DATA_KEY}"
                echo "DATA_HASH_SALT=${DATA_HASH_SALT}"
                echo "FEISHU_APP_ID=${FEISHU_APP_ID:-cli_a9f7f8703778dcee}"
                echo "FEISHU_APP_SECRET=${FEISHU_APP_SECRET}"
                echo "FEISHU_APP_TOKEN=${FEISHU_APP_TOKEN}"
                echo "FEISHU_TABLE_ID=${FEISHU_TABLE_ID:-tbl0CQ74guMS1IDd}"
                echo "FEISHU_FIELD_NAME=姓名（问卷题）"
                echo "FEISHU_FIELD_PHONE=手机号（问卷题）"
                echo "FEISHU_FIELD_TITLE=职位（问卷题）"
                echo "FEISHU_FIELD_COMPANY=公司（问卷题）"
                echo "FEISHU_FIELD_ID=证件号码（问卷题）"
                echo "FEISHU_FIELD_BUSINESS_TYPE=贵司的业务类型"
                echo "FEISHU_FIELD_DEPARTMENT=您所处的部门（问卷题）"
                echo "FEISHU_FIELD_PROOF_URL=专业观众证明（附件链接）"
                echo "FEISHU_FIELD_SUBMITTED_AT="
                echo "FEISHU_FIELD_SYNC_STATUS="

                if [ -n "${OSS_ACCESS_KEY_ID:-}" ]; then echo "OSS_ACCESS_KEY_ID=${OSS_ACCESS_KEY_ID}"; fi
                if [ -n "${OSS_ACCESS_KEY_SECRET:-}" ]; then echo "OSS_ACCESS_KEY_SECRET=${OSS_ACCESS_KEY_SECRET}"; fi
                if [ -n "${OSS_BUCKET:-}" ]; then echo "OSS_BUCKET=${OSS_BUCKET}"; fi
                if [ -n "${OSS_REGION:-}" ]; then echo "OSS_REGION=${OSS_REGION}"; fi
                if [ -n "${OSS_HOST:-}" ]; then echo "OSS_HOST=${OSS_HOST}"; fi
                if [ -n "${OSS_PUBLIC_BASE_URL:-}" ]; then echo "OSS_PUBLIC_BASE_URL=${OSS_PUBLIC_BASE_URL}"; fi
                if [ -n "${OSS_UPLOAD_PREFIX:-}" ]; then echo "OSS_UPLOAD_PREFIX=${OSS_UPLOAD_PREFIX}"; fi
                if [ -n "${OSS_MAX_UPLOAD_MB:-}" ]; then echo "OSS_MAX_UPLOAD_MB=${OSS_MAX_UPLOAD_MB}"; fi
                if [ -n "${OSS_POLICY_EXPIRE_SECONDS:-}" ]; then echo "OSS_POLICY_EXPIRE_SECONDS=${OSS_POLICY_EXPIRE_SECONDS}"; fi
                if [ -n "${OSS_OBJECT_ACL:-}" ]; then echo "OSS_OBJECT_ACL=${OSS_OBJECT_ACL}"; fi
              } > "${RELEASE_DIR}/apps/api/.env"
            fi

            (cd "${RELEASE_DIR}/apps/api" && npm run prisma:migrate)

            ln -sfn "${RELEASE_DIR}" "${CURRENT_LINK}"

            if ! command -v pm2 >/dev/null 2>&1; then
              npm install -g pm2
            fi

            pm2 delete fbif-mock-api >/dev/null 2>&1 || true

            pm2 delete fbif-api >/dev/null 2>&1 || true
            pm2 start "${CURRENT_LINK}/apps/api/dist/index.js" --name fbif-api --cwd "${CURRENT_LINK}/apps/api" --update-env

            pm2 delete fbif-worker >/dev/null 2>&1 || true
            pm2 start "${CURRENT_LINK}/apps/api/dist/worker.js" --name fbif-worker --cwd "${CURRENT_LINK}/apps/api" --update-env

            pm2 delete fbif-web >/dev/null 2>&1 || true
            if ss -lnt | grep -q ':3001 '; then
              echo "Port 3001 already in use, skip pm2 web startup (external web runtime expected)."
            else
              pm2 serve "${CURRENT_LINK}/apps/web/dist" 3001 --name fbif-web --spa
            fi

            pm2 save
            pm2 startup systemd -u root --hp /root || true

            wait_http() {
              local url="$1"
              local retries="${2:-20}"
              local i=1
              while [ "$i" -le "$retries" ]; do
                if curl -fsS "$url" >/dev/null; then
                  return 0
                fi
                sleep 1
                i=$((i + 1))
              done

              echo "health check failed: ${url}" >&2
              pm2 ls --no-color || true
              pm2 logs fbif-api --lines 80 --nostream || true
              pm2 logs fbif-worker --lines 80 --nostream || true
              return 1
            }

            wait_http http://127.0.0.1:8080/health 20
            wait_http http://127.0.0.1:3001 10

            ls -1dt "${RELEASES_DIR}"/* 2>/dev/null | tail -n +6 | xargs -r rm -rf
          REMOTE_SCRIPT

          REMOTE_ENV="$(printf \
            "APP_DIR=%q WEB_ORIGIN=%q DATABASE_URL=%q REDIS_URL=%q DATA_KEY=%q DATA_HASH_SALT=%q FEISHU_APP_ID=%q FEISHU_APP_SECRET=%q FEISHU_APP_TOKEN=%q FEISHU_TABLE_ID=%q OSS_ACCESS_KEY_ID=%q OSS_ACCESS_KEY_SECRET=%q OSS_BUCKET=%q OSS_REGION=%q OSS_HOST=%q OSS_PUBLIC_BASE_URL=%q OSS_UPLOAD_PREFIX=%q OSS_MAX_UPLOAD_MB=%q OSS_POLICY_EXPIRE_SECONDS=%q OSS_OBJECT_ACL=%q GH_SHA=%q" \
            "${APP_DIR:-}" "${WEB_ORIGIN:-}" "${DATABASE_URL:-}" "${REDIS_URL:-}" "${DATA_KEY:-}" "${DATA_HASH_SALT:-}" "${FEISHU_APP_ID:-}" "${FEISHU_APP_SECRET:-}" "${FEISHU_APP_TOKEN:-}" "${FEISHU_TABLE_ID:-}" "${OSS_ACCESS_KEY_ID:-}" "${OSS_ACCESS_KEY_SECRET:-}" "${OSS_BUCKET:-}" "${OSS_REGION:-}" "${OSS_HOST:-}" "${OSS_PUBLIC_BASE_URL:-}" "${OSS_UPLOAD_PREFIX:-}" "${OSS_MAX_UPLOAD_MB:-}" "${OSS_POLICY_EXPIRE_SECONDS:-}" "${OSS_OBJECT_ACL:-}" "${GH_SHA}")"

          ssh \
            -i ~/.ssh/id_aliyun \
            -o BatchMode=yes \
            -o ConnectTimeout=20 \
            -o StrictHostKeyChecking=accept-new \
            "${USER}@${HOST}" \
            "${REMOTE_ENV} bash -s" < /tmp/remote_deploy.sh

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/id_aliyun /tmp/remote_deploy.sh /tmp/release.tgz release.tgz
